<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.kr.gaepan.mapper.admin.MybatisAdminBoardMapper">

    <!-- board 조회수 증가 -->
    <update id="updateViewCnt" parameterType="int">
        UPDATE gp_board SET hit = hit + 1
        WHERE bno = #{bno}
    </update>

    <!-- 검색 쿼리 -->
    <sql id="search">
        <if test='searchType != null and !searchType.equals("") and searchType != "n" '>
            <choose>
                <when test='searchType == "tc"'>
                    <!--
                        CONCAT : 문자열 이어주기 위해 쓰는친구
                        Like : 해당 문자열 있으면 검색
                        % == *
                    -->
                    AND title LIKE CONCAT('%',#{keyword},'%')
                    OR content LIKE CONCAT('%',#{keyword},'%')
                </when>
                <when test='searchType == "tcw"'>
                    AND title LIKE CONCAT('%',#{keyword},'%')
                    OR content LIKE CONCAT('%',#{keyword},'%')
                    OR uid LIKE CONCAT('%',#{keyword},'%')
                </when>
                <otherwise>
                    <!--
                       나머지는 searchType과 검색하고자하는 열이 같으니깐 이렇게 표현 해줄 수 있음
                       ${}로 하는 이유는 #{}을 하면 WHERE 'searchType'이 되니깐 문법적 오류다
                   -->
                    AND ${searchType} LIKE CONCAT('%',#{keyword},'%')
                </otherwise>
            </choose>
        </if>
    </sql>

    <!-- board List 출력 -> [검색에 따라서] paging 처리까지 됨 -->
    <select id="searchList" resultType="co.kr.gaepan.dto.admin.GP_AdminBoardDTO">
        SELECT * FROM gp_board
        WHERE `group` = #{group}
        <include refid="search" />
        ORDER BY bno DESC
        LIMIT #{startRow}, #{perPageNum}
    </select>

    <!-- 해당 검색 결과에 나오는 게시글 총 개수 -->
    <select id = "searchListCount" parameterType="co.kr.gaepan.util.SearchCriteria"
            resultType="int">
        SELECT count(*) FROM gp_board
        WHERE 1 = 1
        <include refid="search" />
    </select>

    <select id = "cateAndType" resultType="co.kr.gaepan.dto.admin.GP_AdminBoardDTO">
        SELECT
            bno,
            `group`,
            b.cate,
            b.`type`,
            bc.cateName,
            bt.typeName
        FROM gp_board AS b
        JOIN gp_board_cate AS bc
        ON b.cate = bc.cate
        JOIN gp_board_type AS bt
        ON b.`type` = bt.`type`
        WHERE `group` = #{group}
        AND (
            <choose>
                <!-- cate가 10, 20, 30일 경우 -->
                <when test="cate == 10 or cate == 20 or cate == 30">
                    1=1 <!-- 전체 조회를 위한 항상 참인 조건 -->
                </when>
                <!-- 그 이외의 경우 -->
                <otherwise>
                    b.cate = #{cate}
                </otherwise>
            </choose>
        )
        ORDER BY bno DESC;
    </select>

    <!--resultType="co.kr.gaepan.dto.admin.GP_AdminBoardDTO"-->
</mapper>